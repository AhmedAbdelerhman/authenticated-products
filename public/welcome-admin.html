<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <!-- Include Vue.js and Axios from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Optional: Include Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Inline styles for basic styling -->
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .form-container {
      max-width: 400px;
      margin: 0 auto;
    }

    .mt-20 {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- Vue app container -->
    <div v-if="!token">
      <!-- Login Form -->
      <div class="form-container">
        <h2>Login</h2>
        <form @submit.prevent="login">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" class="form-control" id="username" v-model="credentials.username" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" class="form-control" id="password" v-model="credentials.password" required>
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>
    </div>
    <div v-else>
      <!-- Admin Panel -->
      <div>
        <h2>Welcome, Admin!</h2>
        <div class="mt-20">
          <h3>System Statistics</h3>
          <!-- Display system statistics here -->
          <p>Total Users: {{ totalUsers }}</p>
          <p>Total requests: {{ totalRequests }}</p>
          <p>Total downloadNumber: {{ totalDownlandNumber }}</p>
        </div>
        <div class="mt-20">
          <h3>User Table</h3>
          <!-- Display paginated user table -->
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Address</th>
                <th>City</th>
                <th>Country</th>
                <th>Postal Code</th>
                <th>Created At</th>
                <th>Updated At</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="user in users" :key="user.id">
                <td>{{ user.id }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.firstName }}</td>
                <td>{{ user.lastName }}</td>
                <td>{{ user.address }}</td>
                <td>{{ user.city }}</td>
                <td>{{ user.country }}</td>
                <td>{{ user.postalCode }}</td>
                <td>{{ new Date(user.createdAt).toLocaleString() }}</td>
                <td>{{ new Date(user.updatedAt).toLocaleString() }}</td>
              </tr>
            </tbody>
          </table>
          <!-- Pagination Controls -->
          <nav>
            <ul class="pagination">
              <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
              </li>
              <li class="page-item" v-for="page in totalPages" :key="page" :class="{ active: currentPage === page }">
                <a class="page-link" href="#" @click.prevent="changePage(page)">{{ page }}</a>
              </li>
              <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Vue app initialization
    new Vue({
      el: '#app',
      data() {
        return {
          credentials: {
            username: '',
            password: ''
          },
          token: '',
          users: [],
          totalUsers: 0,
          currentPage: 1,
          limit: 10,
          totalPages: 0,
          totalRequests: 0,
          totalDownlandNumber: 0
        };
      },
      mounted() {
        // Check if token exists in local storage
        const token = localStorage.getItem('token');
        if (token) {
          this.token = token;
          // Load system statistics and user data
          this.loadUsers();
        }
      },
      methods: {
        async login() {
          try {
            const response = await axios.post('https://authintated-products.onrender.com/v1/admin/auth/login', {
              username: this.credentials.username,
              password: this.credentials.password,
              tokenSecondsDuration: 80000
            }, {
              headers: {
                'Content-Type': 'application/json',
                'Accept': '*/*',
                'Cache-Control': 'no-cache',
              }
            });

            const { token } = response.data.data; // Assuming the token is returned from backend
            this.token = token;
            localStorage.setItem('token', token);

            // Load system statistics and user data after successful login
            this.loadUsers();
          } catch (error) {
            if (error.response && error.response.status === 400) {
              alert('Invalid username or password');
              console.error('Error during login:', error.response.data);
            } else {
              console.error('Error during login:', error);
            }
          }
        },
        async loadUsers() {
          try {
            // Replace with actual backend API endpoint to fetch users
            const response = await axios.get('https://authintated-products.onrender.com/v1/admin/statics', {
              headers: {
                Authorization: `Bearer ${this.token}`
              },
              params: {
                limit: this.limit,
                page: this.currentPage
              }
            });

            this.totalUsers = response.data.meta.total;
            this.totalRequests = response.data.meta.totalRequest;
            this.totalDownlandNumber = response.data.meta.totalDownlandNumber;
            this.users = response.data.data; // Example: Assuming response.data contains users array
            this.totalPages = Math.ceil(this.totalUsers / this.limit);
          } catch (error) {
            if (error.response && error.response.status === 403) {
              // If the error status is 403, delete the token and reload the page
              localStorage.removeItem('token');
              this.token = '';
            } else {
              console.error('Error loading users:', error);
            }
          }
        }, changePage(page) {
          if (page >= 1 && page <= this.totalPages) {
            this.currentPage = page;
            this.loadUsers();
          }
        }
      }
    });
  </script>
</body>

</html>